name: Tests
on:
  push:
  pull_request:
  schedule:
    - cron:  '0 15 * * 0'

jobs:
  tests-on-linux:
    name: Tests on Linux
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm]
        module: ["core", "metrics", "rules", "reporters", "driver"]
        include:
          - module: "core"
            deps: ""
          - module: "metrics"
            deps: ""
          - module: "rules"
            deps: "core metrics"
          - module: "reporters"
            deps: "core"
          - module: "driver"
            deps: "core"
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - env:
          MODULE: ${{ matrix.module }}
          DEPS: ${{ matrix.deps }}
        run: cd oclint-scripts && ./gh-actions test $MODULE $DEPS && cd ..
      #- env:
      #    MODULE: ${{ matrix.module }}
      #   run: |
      #     sudo apt-get install -y lcov
      #     lcov --capture --directory build/oclint-${MODULE}-test --output-file lcov.info
      #     lcov --extract lcov.info "*oclint-${MODULE}/*" --output-file lcov.info
      #     lcov --remove lcov.info "*oclint-${MODULE}/test*" --output-file lcov.info
      #     lcov --list lcov.info
      #   if:  matrix.module != 'driver'
      # - name: Coveralls Parallel
      #   uses: coverallsapp/github-action@master
      #   with:
      #     github-token: ${{ secrets.github_token }}
      #     parallel: true
      #     flag-name: cov-${{ github.run_number }}-linux-${{ matrix.module }}
      #     path-to-lcov: lcov.info
      #   if:  matrix.module != 'driver'
  tests-on-mac:
    name: Tests on macOS
    strategy:
      fail-fast: false
      matrix:
        include:
          - module: "core"
            deps: ""
          - module: "metrics"
            deps: ""
          - module: "rules"
            deps: "core metrics"
          - module: "reporters"
            deps: "core"
          - module: "driver"
            deps: "core"
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - env:
          MODULE: ${{ matrix.module }}
          DEPS: ${{ matrix.deps }}
        run: cd oclint-scripts && ./gh-actions test $MODULE $DEPS
        continue-on-error: true
      - name: Debug - inspect test binaries and runtime
        env:
          MODULE: ${{ matrix.module }}
        run: |
          echo "=== System clang version ==="
          clang++ --version
          echo "=== Prebuilt clang version ==="
          build/llvm-install/bin/clang++ --version 2>/dev/null || echo "not found"
          echo "=== Find test binaries ==="
          find build/oclint-${MODULE}-test -type f -perm +111 -name '*Test*' -o -name '*test*' 2>/dev/null | head -10 || echo "none found"
          echo "=== otool -L on test binaries ==="
          for bin in $(find build/oclint-${MODULE}-test -type f -perm +111 -name '*Test*' -o -name '*test*' 2>/dev/null | head -3); do
            echo "--- $bin ---"
            otool -L "$bin" 2>/dev/null || true
          done
          echo "=== otool -l rpaths on first test binary ==="
          FIRST_BIN=$(find build/oclint-${MODULE}-test -type f -perm +111 -name '*Test*' 2>/dev/null | head -1)
          if [ -n "$FIRST_BIN" ]; then
            otool -l "$FIRST_BIN" 2>/dev/null | grep -A2 LC_RPATH || echo "no rpaths"
            echo "=== DYLD_PRINT_LIBRARIES - run test binary ==="
            DYLD_PRINT_LIBRARIES=1 "$FIRST_BIN" --gtest_list_tests 2>&1 | head -50 || true
          fi
      # - env:
      #     MODULE: ${{ matrix.module }}
      #   run: |
      #     brew install lcov
      #     lcov --capture --directory build/oclint-${MODULE}-test --output-file lcov.info
      #     lcov --extract lcov.info "*oclint-${MODULE}/*" --output-file lcov.info
      #     lcov --remove lcov.info "*oclint-${MODULE}/test*" --output-file lcov.info
      #     lcov --list lcov.info
      #   if:  matrix.module != 'driver'
      # - name: Coveralls Parallel
      #   uses: coverallsapp/github-action@master
      #   with:
      #     github-token: ${{ secrets.github_token }}
      #     parallel: true
      #     flag-name: cov-${{ github.run_number }}-macos-${{ matrix.module }}
      #     path-to-lcov: lcov.info
      #   if:  matrix.module != 'driver'
  # wrap-up:
  #   needs: [tests-on-linux, tests-on-mac]
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Coveralls Finished
  #     uses: coverallsapp/github-action@master
  #     with:
  #       github-token: ${{ secrets.github_token }}
  #       parallel-finished: true
