name: Tests
on:
  push:
  pull_request:
  schedule:
    - cron:  '0 15 * * 0'

jobs:
  tests-on-linux:
    name: Tests on Linux
    strategy:
      fail-fast: false
      matrix:
        include:
          - module: "core"
            deps: ""
          - module: "metrics"
            deps: ""
          - module: "rules"
            deps: "core metrics"
          - module: "reporters"
            deps: "core"
          - module: "driver"
            deps: "core"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - env:
          MODULE: ${{ matrix.module }}
          DEPS: ${{ matrix.deps }}
        run: cd oclint-scripts && ./gh-actions test $MODULE $DEPS && cd ..
      #- env:
      #    MODULE: ${{ matrix.module }}
      #   run: |
      #     sudo apt-get install -y lcov
      #     lcov --capture --directory build/oclint-${MODULE}-test --output-file lcov.info
      #     lcov --extract lcov.info "*oclint-${MODULE}/*" --output-file lcov.info
      #     lcov --remove lcov.info "*oclint-${MODULE}/test*" --output-file lcov.info
      #     lcov --list lcov.info
      #   if:  matrix.module != 'driver'
      # - name: Coveralls Parallel
      #   uses: coverallsapp/github-action@master
      #   with:
      #     github-token: ${{ secrets.github_token }}
      #     parallel: true
      #     flag-name: cov-${{ github.run_number }}-linux-${{ matrix.module }}
      #     path-to-lcov: lcov.info
      #   if:  matrix.module != 'driver'
  tests-on-mac:
    name: Tests on macOS
    strategy:
      fail-fast: false
      matrix:
        include:
          - module: "core"
            deps: ""
          - module: "metrics"
            deps: ""
          - module: "rules"
            deps: "core metrics"
          - module: "reporters"
            deps: "core"
          - module: "driver"
            deps: "core"
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Install LLVM 21 from Homebrew for ABI compatibility
        run: |
          brew install llvm@21
          echo "Using Homebrew LLVM 21 clang for C++ ABI compatibility with prebuilt LLVM 21 libraries"
          echo "CC=/opt/homebrew/opt/llvm@21/bin/clang" >> $GITHUB_ENV
          echo "CXX=/opt/homebrew/opt/llvm@21/bin/clang++" >> $GITHUB_ENV
          # Add Homebrew LLVM's include and lib directories to flags
          # This ensures the compiler finds its own libc++ headers and libraries
          echo "CFLAGS=-isystem /opt/homebrew/opt/llvm@21/include" >> $GITHUB_ENV
          echo "CXXFLAGS=-isystem /opt/homebrew/opt/llvm@21/include -isystem /opt/homebrew/opt/llvm@21/include/c++/v1" >> $GITHUB_ENV
          echo "LDFLAGS=-L/opt/homebrew/opt/llvm@21/lib -Wl,-rpath,/opt/homebrew/opt/llvm@21/lib" >> $GITHUB_ENV
      - env:
          MODULE: ${{ matrix.module }}
          DEPS: ${{ matrix.deps }}
        run: cd oclint-scripts && ./gh-actions test $MODULE $DEPS && cd ..
      # - env:
      #     MODULE: ${{ matrix.module }}
      #   run: |
      #     brew install lcov
      #     lcov --capture --directory build/oclint-${MODULE}-test --output-file lcov.info
      #     lcov --extract lcov.info "*oclint-${MODULE}/*" --output-file lcov.info
      #     lcov --remove lcov.info "*oclint-${MODULE}/test*" --output-file lcov.info
      #     lcov --list lcov.info
      #   if:  matrix.module != 'driver'
      # - name: Coveralls Parallel
      #   uses: coverallsapp/github-action@master
      #   with:
      #     github-token: ${{ secrets.github_token }}
      #     parallel: true
      #     flag-name: cov-${{ github.run_number }}-macos-${{ matrix.module }}
      #     path-to-lcov: lcov.info
      #   if:  matrix.module != 'driver'
  # wrap-up:
  #   needs: [tests-on-linux, tests-on-mac]
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Coveralls Finished
  #     uses: coverallsapp/github-action@master
  #     with:
  #       github-token: ${{ secrets.github_token }}
  #       parallel-finished: true
